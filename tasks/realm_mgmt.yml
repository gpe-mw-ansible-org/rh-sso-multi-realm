---

- set_fact:
    retrieve_token_url: "{{rhsso_url}}/auth/realms/master/protocol/openid-connect/token"
- set_fact:
    create_realm_url: "{{rhsso_url}}/auth/admin/realms"
- set_fact:
    delete_realm_sub_url: "{{rhsso_url}}/auth/admin/realms"





# 1)  Get access and refresh OAuth tokens
- name: SSO Realm management starting
  include: refreshOAuthTokens.yml


# 2)  Create or delete configurable number of realms
#- name: "Loop through realm prep {{start_realm}} {{end_realm}}"
#  include: realmPrep.yml realmId="realm{{item}}"
#  loop: "{{ range(start_realm|int, end_realm|int + 1, 1)|list }}"


# 3) Load realm to facilitate business automation tooling (Process Automation Manager / Decision Manager)
- block:
    - name: "Load realm to facilitate business automation tooling (Process Automation Manager / Decision Manager)"
      template:
        src: templates/kie-realm.json
        dest: "{{new_app_output_dir}}/kie-realm.json"
        mode: 0755
    - set_fact:
        realmId: 'kieRealm'
    - set_fact:
         realm_body: "{{ lookup('file', '{{new_app_output_dir}}/kie-realm.json' ) }}"
    - debug:
        msg: "realm_body = {{realm_body}}"
        verbosity: 1
    - include: realmCreate.yml realmId="{{realmId}}"
    - debug:
        msg: "kie-realm.json      create_realm_response = {{create_realm_response}}"
  when: loadKieRealm|bool


- pause:
    seconds: "{{realm_loop_delay}}"


# 4) Configure OCP to use RH-SSO for Authentication
- block:
    - name: "Configure OCP to use RH-SSO for Authentication"
      set_fact:
        realmId: 'ocpRealm'
    - name: set fact ocp_master_url
      shell: |
        oc whoami --show-server
      register: ocp_master_url
    - debug:
        msg: "{{ realmId }}  ocp_master_url = {{ ocp_master_url.stdout }}"
        verbosity: 0
    - template:
        src: templates/ocp-realm.json
        dest: "{{new_app_output_dir}}/ocp-realm.json"
        mode: 0755
    - set_fact:
         realm_body: "{{ lookup('file', '{{new_app_output_dir}}/ocp-realm.json' ) }}"
    - debug:
        msg: "{{ realmId }}  realm_body = {{realm_body}}"
        verbosity: 1
    - include: realmCreate.yml realmId="{{realmId}}"
    - debug:
        msg: "ocp-realm.json      create_realm_response = {{create_realm_response}}"
  when: loadOCPRealm|bool



# 3)  Print log messages
- name: Realm Rollout Complete
  debug:
    msg:
      - "create_realms: {{create_realms}}"
      - "new_app_output_dir:  {{new_app_output_dir}}"
      - "realm_management_log_file = {{new_app_output_dir}}/{{realm_provisioning_log_file}}"
      - "start and end realms = {{start_realm}}  {{end_realm}}"
